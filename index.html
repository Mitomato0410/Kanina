<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>â„ï¸ å…”å­é­”å¥³é»æ­Œç³»çµ± â™ª</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        /* ç³–æœç²‰è—èˆ’å£“é¢¨æ ¼å…¨å±€è¨­å®š */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Noto Sans TC', 'Poppins', sans-serif; 
            background: linear-gradient(135deg, #E0F2FE 0%, #F0F9FF 100%); 
            color: #475569; 
            min-height: 100vh; 
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* Header æ”¹ç‚ºæ£‰èŠ±ç³–è—æ¼¸å±¤ */
        .header { 
            text-align: center; 
            padding: 40px 20px; 
            background: linear-gradient(135deg, #7DD3FC 0%, #38BDF8 100%); 
            border-radius: 0 0 30px 30px; 
            box-shadow: 0 4px 20px rgba(56, 189, 248, 0.2); 
            margin-bottom: 30px; 
        }
        .header h1 { font-size: 2.2rem; font-weight: 700; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; }

        .section-card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); margin-bottom: 25px; }
        
        .search-input { width: 100%; padding: 12px 20px; border: 2px solid #E0F2FE; border-radius: 15px; margin-bottom: 15px; outline: none; transition: 0.3s; }
        .search-input:focus { border-color: #7DD3FC; box-shadow: 0 0 10px rgba(125,211,252,0.1); }
        
        .filter-btn { padding: 8px 18px; border: 2px solid #7DD3FC; background: white; color: #0EA5E9; border-radius: 25px; cursor: pointer; transition: all 0.3s; font-weight: 600; font-size: 0.9rem; }
        .filter-btn.active { background: #7DD3FC; color: white; }

        .songs-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .song-card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.04); border: 2px solid transparent; transition: all 0.3s; display: flex; flex-direction: column; justify-content: space-between; position: relative; }
        .song-card:hover { transform: translateY(-5px); border-color: #7DD3FC; }
        
        .request-btn { width: 100%; padding: 12px; border: none; border-radius: 15px; background: linear-gradient(135deg, #7DD3FC 0%, #38BDF8 100%); color: white; font-weight: 700; cursor: pointer; margin-top: 15px; transition: 0.3s; box-shadow: 0 4px 10px rgba(125, 211, 252, 0.3); }
        .request-btn:hover { opacity: 0.9; transform: scale(1.02); }
        .request-btn:disabled { background: #CBD5E1; cursor: not-allowed; box-shadow: none; }

        .status-singing { background: #F0F9FF; color: #0EA5E9; animation: pulse 2s infinite; border-radius: 10px; padding: 4px 10px; font-weight: 600; font-size: 0.85rem; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        /* Modal ç®¡ç†å½ˆçª— */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.4); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 25px; padding: 30px; max-width: 450px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #334155; color: white; padding: 12px 30px; border-radius: 50px; display: none; z-index: 3000; box-shadow: 0 10px 15px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

    <div class="header">
        <h1 onclick="toggleMode()">â„ï¸å…”å­é­”å¥³é»æ­Œç³»çµ± â™ª</h1>
    </div>

    <div class="container">
        <div id="audienceView">
            <div class="section-card">
                <h3 class="font-bold mb-3 text-sky-400 text-lg flex items-center">ğŸµ ç›®å‰æ’éšŠæ¸…å–®</h3>
                <div id="queueList" class="space-y-2 text-slate-400">è¼‰å…¥ä¸­...</div>
            </div>

            <div class="section-card">
                <input type="text" id="searchInput" class="search-input" placeholder="ğŸ” æœå°‹æ­Œåã€æ­Œæ‰‹æˆ–é—œéµå­—...">
                <div id="filterButtons" class="flex gap-2 flex-wrap">
                    <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>
                    <button class="filter-btn" data-filter="ä¸­æ–‡æ­Œ">ä¸­æ–‡æ­Œ</button>
                    <button class="filter-btn" data-filter="æ—¥æ–‡æ­Œ">æ—¥æ–‡æ­Œ</button>
                    <button class="filter-btn" data-filter="è‹±æ–‡æ­Œ">è‹±æ–‡æ­Œ</button>
                </div>
            </div>

            <div class="songs-grid" id="songsGrid"></div>
        </div>

        <div id="managementView" style="display:none;">
            <div class="bg-white p-6 rounded-2xl mb-6 shadow-sm flex flex-wrap justify-between items-center gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-sky-500">å¾Œå°ç®¡ç† â„ï¸</h2>
                    <p class="text-xs text-slate-400">å°ˆå±¬å†¬æ—¥ç³–æœè—ç‰ˆ</p>
                </div>
                <div class="flex gap-2">
                    <button class="bg-slate-500 text-white px-4 py-2 rounded-xl text-sm font-bold" onclick="location.reload()">ğŸ”„ åˆ·æ–°</button>
                    <button class="bg-sky-500 text-white px-4 py-2 rounded-xl text-sm font-bold" onclick="openSongModal()">æ–°å¢æ­Œæ›² +</button>
                    <button class="bg-slate-200 text-slate-600 px-4 py-2 rounded-xl text-sm font-bold" onclick="exitAdmin()">é€€å‡º</button>
                </div>
            </div>
            <div id="adminSongList" class="grid gap-4"></div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <div id="songModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle" class="text-xl font-bold mb-4">æ–°å¢æ­Œå–®æ­Œæ›²</h3>
            <div class="space-y-4">
                <input type="text" id="songName" class="search-input mb-0" placeholder="æ­Œå">
                <input type="text" id="songArtist" class="search-input mb-0" placeholder="åŸå”±/æ­Œæ‰‹">
                <div class="flex gap-2 flex-wrap">
                    <label><input type="checkbox" class="tag-input" value="ä¸­æ–‡æ­Œ"> ä¸­æ–‡</label>
                    <label><input type="checkbox" class="tag-input" value="æ—¥æ–‡æ­Œ"> æ—¥æ–‡</label>
                    <label><input type="checkbox" class="tag-input" value="è‹±æ–‡æ­Œ"> è‹±æ–‡</label>
                </div>
                <div class="flex gap-4 mt-6">
                    <button class="flex-1 bg-slate-100 py-3 rounded-xl font-bold" onclick="closeSongModal()">å–æ¶ˆ</button>
                    <button class="flex-1 bg-sky-500 text-white py-3 rounded-xl font-bold" onclick="saveSong()">å„²å­˜æ­Œæ›²</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // KANINA å°ˆæ¡ˆé‡‘é‘°é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyAneZhM_CWic_YIY6kf0su5ithDyqw8Kkc",
            authDomain: "kanina-6f030.firebaseapp.com",
            projectId: "kanina-6f030",
            storageBucket: "kanina-6f030.firebasestorage.app",
            messagingSenderId: "256118663625",
            appId: "1:256118663625:web:90a06e12a37129e5676018",
            databaseURL: "https://kanina-6f030-default-rtdb.firebaseio.com"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let allSongs = [];
        let queue = [];
        let currentFilter = 'all';
        let isAdmin = false;

        // åˆå§‹åŒ–è³‡æ–™ç›£è½
        function init() {
            db.ref('songs').on('value', snapshot => {
                const data = snapshot.val();
                allSongs = data ? Object.entries(data).map(([id, s]) => ({id, ...s})) : [];
                render();
            });

            db.ref('queue').on('value', snapshot => {
                const data = snapshot.val();
                queue = data ? Object.entries(data).map(([id, q]) => ({id, ...q})) : [];
                renderQueue();
            });
        }

        // æ¸²æŸ“è§€çœ¾æ­Œå–®
        function render() {
            const grid = document.getElementById('songsGrid');
            const adminList = document.getElementById('adminSongList');
            const search = document.getElementById('searchInput').value.toLowerCase();
            
            grid.innerHTML = '';
            adminList.innerHTML = '';

            allSongs.forEach(song => {
                const matchesSearch = song.name.toLowerCase().includes(search) || song.artist.toLowerCase().includes(search);
                const matchesFilter = currentFilter === 'all' || (song.tags && song.tags.includes(currentFilter));

                // è§€çœ¾ç«¯æ¸²æŸ“ (åªé¡¯ç¤ºæœªéš±è—çš„)
                if (matchesSearch && matchesFilter && !song.hidden) {
                    const isInQueue = queue.some(q => q.songId === song.id && q.status !== 'done');
                    grid.innerHTML += `
                        <div class="song-card">
                            <div>
                                <h4 class="font-bold text-lg">${song.name}</h4>
                                <p class="text-slate-400 text-sm">${song.artist}</p>
                            </div>
                            <button class="request-btn" onclick="requestSong('${song.id}')" ${isInQueue ? 'disabled' : ''}>
                                ${isInQueue ? 'æ’éšŠä¸­...' : 'æˆ‘è¦é»æ­Œ'}
                            </button>
                        </div>
                    `;
                }

                // ç®¡ç†ç«¯æ¸²æŸ“
                adminList.innerHTML += `
                    <div class="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center border ${song.hidden ? 'opacity-50 grayscale' : 'border-sky-50'}">
                        <div>
                            <span class="font-bold">${song.name}</span>
                            <span class="text-xs text-slate-400 ml-2">${song.artist}</span>
                        </div>
                        <div class="flex gap-2">
                            <button class="text-xs bg-slate-100 px-3 py-1 rounded-lg" onclick="toggleHide('${song.id}', ${song.hidden})">
                                ${song.hidden ? 'é¡¯ç¤º' : 'éš±è—'}
                            </button>
                            <button class="text-xs bg-red-50 text-red-500 px-3 py-1 rounded-lg" onclick="deleteSong('${song.id}')">åˆªé™¤</button>
                        </div>
                    </div>
                `;
            });
        }

        // æ¸²æŸ“æ’éšŠæ¸…å–®
        function renderQueue() {
            const list = document.getElementById('queueList');
            const activeQueue = queue.filter(q => q.status !== 'done');
            
            if (activeQueue.length === 0) {
                list.innerHTML = 'â„ï¸é›ªåœ°è£¡éœæ‚„æ‚„çš„ï¼Œé‚„æ²’æœ‰äººé»æ­Œå“¦ï¼';
                return;
            }

            list.innerHTML = activeQueue.map((q, index) => `
                <div class="flex justify-between items-center bg-sky-50/50 p-3 rounded-xl border border-sky-100">
                    <div>
                        <span class="text-sky-500 font-bold mr-2">#${index + 1}</span>
                        <span class="font-medium">${q.songName}</span>
                    </div>
                    ${index === 0 ? '<span class="status-singing">æ­£åœ¨æ¼”å”± â™ª</span>' : '<span class="text-xs text-slate-400">ç­‰å€™ä¸­</span>'}
                    ${isAdmin ? `<button class="text-xs bg-sky-400 text-white px-2 py-1 rounded" onclick="markDone('${q.id}')">å”±å®Œ</button>` : ''}
                </div>
            `).join('');
        }

        // åŠŸèƒ½å‡½æ•¸
        function requestSong(songId) {
            const song = allSongs.find(s => s.id === songId);
            db.ref('queue').push({
                songId,
                songName: song.name,
                status: 'pending',
                timestamp: Date.now()
            });
            showToast('é»æ­ŒæˆåŠŸï¼è«‹è€å¿ƒç­‰å€™å¡å¦®å¨œâ„ï¸');
        }

        function markDone(queueId) {
            db.ref(`queue/${queueId}`).update({ status: 'done' });
        }

        function toggleHide(id, currentStatus) {
            db.ref(`songs/${id}`).update({ hidden: !currentStatus });
        }

        function deleteSong(id) {
            if(confirm('ç¢ºå®šè¦å¾æ­Œå–®åˆªé™¤å—ï¼Ÿ')) db.ref(`songs/${id}`).remove();
        }

        function saveSong() {
            const name = document.getElementById('songName').value;
            const artist = document.getElementById('songArtist').value;
            const tags = Array.from(document.querySelectorAll('.tag-input:checked')).map(cb => cb.value);

            if(!name) return alert('è«‹è¼¸å…¥æ­Œå');
            
            db.ref('songs').push({ name, artist, tags, hidden: false });
            closeSongModal();
            showToast('æ­Œæ›²å·²åŠ å…¥æ­Œå–®');
        }

        // UI è¼”åŠ©
        function toggleMode() {
            const pwd = prompt("è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ï¼š");
            if(pwd === 'pmdmnmkz4') {
                isAdmin = true;
                document.getElementById('audienceView').style.display = 'none';
                document.getElementById('managementView').style.display = 'block';
                renderQueue();
            } else if(pwd !== null) {
                alert("å¯†ç¢¼éŒ¯èª¤ï¼");
            }
        }

        function exitAdmin() {
            isAdmin = false;
            document.getElementById('audienceView').style.display = 'block';
            document.getElementById('managementView').style.display = 'none';
            renderQueue();
        }

        function openSongModal() { document.getElementById('songModal').classList.add('active'); }
        function closeSongModal() { 
            document.getElementById('songModal').classList.remove('active');
            document.getElementById('songName').value = '';
            document.getElementById('songArtist').value = '';
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        // ç›£è½æœå°‹èˆ‡éæ¿¾
        document.getElementById('searchInput').addEventListener('input', render);
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                currentFilter = e.target.dataset.filter;
                render();
            });
        });

        init();
    </script>
</body>
</html>
